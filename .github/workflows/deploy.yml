name: Test and Deploy to Render

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run simple test
      run: |
        python -c "
        from app import app
        print('Flask app imported successfully')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
        from PIL import Image
        import io
        import matplotlib.pyplot as plt
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        img = Image.new('RGB', (100, 100), color='red')
        print('Test image created')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã
        try:
            plt.figure()
            plt.plot([1,2,3])
            plt.close()
            print('Matplotlib works correctly')
        except:
            print('Matplotlib error')
            raise
        
        print('‚úÖ All basic tests passed')
        "
    
    - name: Test Flask app structure
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        if [ ! -f "app.py" ]; then
          echo "‚ùå app.py not found"
          exit 1
        fi
        
        if [ ! -f "requirements.txt" ]; then
          echo "‚ùå requirements.txt not found"
          exit 1
        fi
        
        if [ ! -d "templates" ]; then
          echo "‚ùå templates directory not found"
          exit 1
        fi
        
        echo "‚úÖ Project structure is correct"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º Python —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
        python -m py_compile app.py
        echo "‚úÖ Python syntax is correct"

  deploy:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to Render
      env:
        RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
        if [ -z "$RENDER_API_KEY" ]; then
          echo "‚ö†Ô∏è RENDER_API_KEY not set. Skipping deployment."
          echo "To enable auto-deployment:"
          echo "1. Go to https://dashboard.render.com/account/api-keys"
          echo "2. Create API key and add to GitHub Secrets as RENDER_API_KEY"
          echo "3. Add your service ID as RENDER_SERVICE_ID"
          exit 0
        fi
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cURL
        apt-get update && apt-get install -y curl
        
        echo "üöÄ Starting deployment to Render..."
        
        # –¢—Ä–∏–≥–≥–µ—Ä–∏–º –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Render API
        curl -X POST \
          "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
          -H "Authorization: Bearer $RENDER_API_KEY" \
          -H "Content-Type: application/json"
        
        echo "‚úÖ Deployment triggered successfully!"
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
        sleep 10
        echo "Check deployment status at: https://dashboard.render.com"
