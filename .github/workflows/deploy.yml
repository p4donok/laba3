name: Test and Deploy

on:
  push:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          cd lab3
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Basic syntax and import check
        run: |
          cd lab3
          python -c "
          # Быстрая проверка импорта всех ключевых библиотек
          try:
              print('1. Checking NumPy version...')
              import numpy
              print(f'    NumPy {numpy.__version__} OK')
              
              print('2. Checking matplotlib...')
              import matplotlib
              import matplotlib.pyplot as plt
              print('    matplotlib OK')
              
              print('3. Checking PIL...')
              from PIL import Image
              print('    PIL OK')
              
              print('4. Checking Flask...')
              import flask
              print('    Flask OK')
              
              print('5. Checking project module...')
              # Пробуем прочитать app.py, но не запускать
              with open('app.py', 'r') as f:
                  content = f.read()
              print(f'    app.py is readable ({len(content)} chars)')
              
              print('\\n✅ Все зависимости импортируются корректно.')
              
          except Exception as e:
              print(f'\\n❌ Ошибка: {e}')
              import traceback
              traceback.print_exc()
              exit(1)
          "

  deploy:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ]; then
            echo "RENDER_API_KEY не настроен. Пропускаем деплой."
            echo "Для настройки:"
            echo "1. Создайте API ключ на https://dashboard.render.com"
            echo "2. Добавьте его в Secrets репозитория как RENDER_API_KEY"
            echo "3. Добавьте ID вашего сервиса как RENDER_SERVICE_ID"
            exit 0
          fi

          echo "Запуск деплоя на Render..."
          curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json"

          echo "Деплой запущен. Статус можно проверить на dashboard.render.com"
